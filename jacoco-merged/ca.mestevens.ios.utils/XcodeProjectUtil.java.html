<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>XcodeProjectUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">xcode-maven-plugin</a> &gt; <a href="index.source.html" class="el_package">ca.mestevens.ios.utils</a> &gt; <span class="el_source">XcodeProjectUtil.java</span></div><h1>XcodeProjectUtil.java</h1><pre class="source lang-java linenums">package ca.mestevens.ios.utils;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;

import lombok.Data;

import org.apache.maven.plugin.MojoExecutionException;

import ca.mestevens.ios.xcode.parser.exceptions.FileReferenceDoesNotExistException;
import ca.mestevens.ios.xcode.parser.exceptions.InvalidObjectFormatException;
import ca.mestevens.ios.xcode.parser.models.CommentedIdentifier;
import ca.mestevens.ios.xcode.parser.models.PBXBuildFile;
import ca.mestevens.ios.xcode.parser.models.PBXBuildPhase;
import ca.mestevens.ios.xcode.parser.models.PBXFileElement;
import ca.mestevens.ios.xcode.parser.models.PBXTarget;
import ca.mestevens.ios.xcode.parser.models.XCConfigurationList;
import ca.mestevens.ios.xcode.parser.models.XCodeProject;

<span class="nc bnc" id="L24" title="All 22 branches missed.">@Data</span>
public class XcodeProjectUtil {
	
<span class="nc" id="L27">	private String pbxProjLocation;</span>
<span class="fc" id="L28">	private XCodeProject xcodeProject;</span>
	
<span class="fc" id="L30">	public XcodeProjectUtil(String pbxProjLocation) throws InvalidObjectFormatException {</span>
<span class="fc" id="L31">		this.pbxProjLocation = pbxProjLocation;</span>
<span class="fc" id="L32">		this.xcodeProject = new XCodeProject(pbxProjLocation);</span>
<span class="fc" id="L33">	}</span>

	public void addDependenciesToTarget(String targetName, List&lt;File&gt; dynamicFrameworks, List&lt;File&gt; staticFrameworks, List&lt;File&gt; libraries) throws MojoExecutionException {
		try {
<span class="fc" id="L37">			List&lt;File&gt; masterFileList = new ArrayList&lt;File&gt;();</span>
<span class="fc bfc" id="L38" title="All 2 branches covered.">			if (libraries == null) {</span>
<span class="fc" id="L39">				libraries = new ArrayList&lt;File&gt;();</span>
			}
<span class="pc bpc" id="L41" title="1 of 2 branches missed.">			if (staticFrameworks == null) {</span>
<span class="fc" id="L42">				staticFrameworks = new ArrayList&lt;File&gt;();</span>
			}
<span class="fc bfc" id="L44" title="All 2 branches covered.">			if (dynamicFrameworks == null) {</span>
<span class="fc" id="L45">				dynamicFrameworks = new ArrayList&lt;File&gt;();</span>
			}
<span class="fc" id="L47">			masterFileList.addAll(libraries);</span>
<span class="fc" id="L48">			masterFileList.addAll(staticFrameworks);</span>
<span class="fc" id="L49">			masterFileList.addAll(dynamicFrameworks);</span>
			//Add the file/build file references
<span class="fc" id="L51">			List&lt;CommentedIdentifier&gt; fileReferenceIdentifiers = addFileReferences(masterFileList);</span>
<span class="fc" id="L52">			List&lt;CommentedIdentifier&gt; libraryBuildIdentifiers = addBuildFiles(libraries, false);</span>
<span class="fc" id="L53">			List&lt;CommentedIdentifier&gt; staticFrameworkBuildIdentifiers = addBuildFiles(staticFrameworks, false);</span>
<span class="fc" id="L54">			List&lt;CommentedIdentifier&gt; dynamicFrameworkBuildIdentifiers = addBuildFiles(dynamicFrameworks, true);</span>
			//Get the target
<span class="fc" id="L56">			PBXTarget target = getNativeTarget(targetName);</span>
			//Link the static libraries
<span class="fc" id="L58">			linkLibraries(target.getReference().getIdentifier(), libraryBuildIdentifiers);</span>
<span class="fc" id="L59">			linkLibraries(target.getReference().getIdentifier(), staticFrameworkBuildIdentifiers);</span>
			//Embed the dynamic libraries
<span class="fc" id="L61">			embedLibraries(target, dynamicFrameworkBuildIdentifiers);</span>
			//Add the properties to the build configuration
<span class="fc" id="L63">			XCConfigurationList configuration = xcodeProject.getConfigurationListWithIdentifier(target.getBuildConfigurationList().getIdentifier());</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">			for(CommentedIdentifier identifier : configuration.getBuildConfigurations()) {</span>
<span class="pc bpc" id="L65" title="3 of 8 branches missed.">				if ((dynamicFrameworks != null &amp;&amp; dynamicFrameworks.size() &gt; 0) || (staticFrameworks != null &amp;&amp; staticFrameworks.size() &gt; 0)) {</span>
<span class="fc" id="L66">					addPropertyToList(identifier.getIdentifier(), &quot;FRAMEWORK_SEARCH_PATHS&quot;, &quot;\&quot;${PROJECT_DIR}/target/xcode-dependencies/frameworks/**\&quot;&quot;);</span>
<span class="fc" id="L67">					addPropertyToString(identifier.getIdentifier(), &quot;LD_RUNPATH_SEARCH_PATHS&quot;, &quot;@loader_path/Frameworks&quot;);</span>
<span class="fc" id="L68">					addPropertyToString(identifier.getIdentifier(), &quot;LD_RUNPATH_SEARCH_PATHS&quot;, &quot;@executable_path/Frameworks&quot;);</span>
				}
<span class="pc bpc" id="L70" title="1 of 4 branches missed.">				if (libraries != null &amp;&amp; libraries.size() &gt; 0) {</span>
<span class="fc" id="L71">					addPropertyToList(identifier.getIdentifier(), &quot;HEADER_SEARCH_PATHS&quot;, &quot;\&quot;${PROJECT_DIR}/target/xcode-dependencies/libraries/**\&quot;&quot;);</span>
<span class="fc" id="L72">					addPropertyToList(identifier.getIdentifier(), &quot;LIBRARY_SEARCH_PATHS&quot;, &quot;\&quot;${PROJECT_DIR}/target/xcode-dependencies/libraries/**\&quot;&quot;);</span>
				}
<span class="fc" id="L74">			}</span>
<span class="fc" id="L75">			createGroup(fileReferenceIdentifiers);</span>
<span class="nc" id="L76">		} catch (Exception ex) {</span>
<span class="nc" id="L77">			ex.printStackTrace();</span>
<span class="nc" id="L78">			throw new MojoExecutionException(ex.getMessage());</span>
<span class="fc" id="L79">		}</span>
<span class="fc" id="L80">	}</span>
	
	public void addPropertyToList(String buildConfiguration, String key, String value) {
<span class="fc" id="L83">		List&lt;String&gt; propertyList = xcodeProject.getBuildConfigurationPropertyAsList(buildConfiguration, key);</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">		if (propertyList == null) {</span>
<span class="fc" id="L85">			propertyList = new ArrayList&lt;String&gt;();</span>
		}
<span class="fc bfc" id="L87" title="All 2 branches covered.">		if (!propertyList.contains(value)) {</span>
<span class="fc" id="L88">			propertyList.add(value);</span>
<span class="fc" id="L89">			xcodeProject.setBuildConfigurationProperty(buildConfiguration, key, propertyList);</span>
		}
<span class="fc" id="L91">	}</span>
	
	public void addPropertyToString(String buildConfiguration, String key, String value) {
<span class="fc" id="L94">		String property = xcodeProject.getBuildConfigurationProperty(buildConfiguration, key);</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">		if (property != null) {</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">			if (property.startsWith(&quot;\&quot;&quot;)) {</span>
<span class="fc" id="L97">				property = property.substring(1);</span>
			}
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">			if (property.endsWith(&quot;\&quot;&quot;)) {</span>
<span class="fc" id="L100">				property = property.substring(0, property.length() - 1);</span>
			}
<span class="fc" id="L102">			property = property.trim();</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">			if (!property.contains(value)) {</span>
<span class="fc" id="L104">				property = property.concat(&quot; &quot; + value);</span>
			}
<span class="fc" id="L106">			property = &quot;\&quot;&quot; + property + &quot;\&quot;&quot;;</span>
<span class="fc" id="L107">			xcodeProject.setBuildConfigurationProperty(buildConfiguration, key, property);</span>
		} else {
<span class="fc" id="L109">			xcodeProject.setBuildConfigurationProperty(buildConfiguration, key, &quot;\&quot;&quot; + value + &quot;\&quot;&quot;);</span>
		}
<span class="fc" id="L111">	}</span>
	
	public List&lt;CommentedIdentifier&gt; addBuildFiles(List&lt;File&gt; files, boolean dynamicFrameworks) throws FileReferenceDoesNotExistException {
		//Add the framework files as file references and build files
<span class="fc" id="L115">		List&lt;CommentedIdentifier&gt; buildFileReferences = new ArrayList&lt;CommentedIdentifier&gt;();</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">		for (File dependencyFile : files) {</span>
<span class="fc" id="L117">			String fileExtension = dependencyFile.getAbsolutePath().substring(dependencyFile.getAbsolutePath().lastIndexOf('.') + 1);</span>
<span class="pc bpc" id="L118" title="1 of 4 branches missed.">			if (fileExtension.equals(&quot;framework&quot;) &amp;&amp; !dynamicFrameworks) {</span>
<span class="nc" id="L119">				File staticLibrary = new File(dependencyFile.getAbsolutePath() + &quot;/&quot; + dependencyFile.getName().substring(0, dependencyFile.getName().lastIndexOf(&quot;.&quot;)));</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">				if (!staticLibrary.exists()) {</span>
<span class="nc" id="L121">					continue;</span>
				}
			}
<span class="fc" id="L124">			String frameworkPath = dependencyFile.getAbsolutePath().substring(dependencyFile.getAbsolutePath().lastIndexOf(&quot;target&quot;));</span>
<span class="fc" id="L125">			List&lt;PBXBuildFile&gt; buildFiles = xcodeProject.getBuildFileWithFileRefPath(frameworkPath);</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">			if (buildFiles.isEmpty()) {</span>
<span class="fc" id="L127">				buildFiles = xcodeProject.getBuildFileWithFileRefPath(&quot;\&quot;&quot; + frameworkPath + &quot;\&quot;&quot;);</span>
			}
<span class="fc" id="L129">			PBXBuildFile buildFile = null;</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">			for (PBXBuildFile existingFile : buildFiles) {</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">				if (existingFile.getReference().getComment().contains(dependencyFile.getName() + &quot; in Frameworks&quot;)) {</span>
<span class="fc" id="L132">					buildFile = existingFile;</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">				} else if (existingFile.getReference().getComment().contains(dependencyFile.getName() + &quot; in Embed Frameworks&quot;)) {</span>
<span class="fc" id="L134">					buildFile = existingFile;</span>
				}
<span class="fc" id="L136">			}</span>
<span class="fc bfc" id="L137" title="All 4 branches covered.">			if (buildFile == null &amp;&amp; dynamicFrameworks) {</span>
<span class="fc" id="L138">				buildFile = xcodeProject.createBuildFileFromFileReferencePath(frameworkPath, dependencyFile.getName() + &quot; in Embed Frameworks&quot;);</span>
<span class="fc" id="L139">				buildFile.getSettings().put(&quot;ATTRIBUTES&quot;, &quot;(CodeSignOnCopy, )&quot;);</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">			} else if (buildFile == null) {</span>
<span class="fc" id="L141">				buildFile = xcodeProject.createBuildFileFromFileReferencePath(frameworkPath, dependencyFile.getName() + &quot; in Frameworks&quot;);</span>
			}
<span class="fc" id="L143">			buildFileReferences.add(buildFile.getReference());</span>
<span class="fc" id="L144">		}</span>
<span class="fc" id="L145">		return buildFileReferences;</span>
	}
	
	public List&lt;CommentedIdentifier&gt; addFileReferences(List&lt;File&gt; files) {
<span class="fc" id="L149">		List&lt;CommentedIdentifier&gt; fileReferences = new ArrayList&lt;CommentedIdentifier&gt;();</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">		for (File dependencyFile : files) {</span>
<span class="fc" id="L151">			String frameworkPath = dependencyFile.getAbsolutePath().substring(dependencyFile.getAbsolutePath().lastIndexOf(&quot;target&quot;));</span>
<span class="fc" id="L152">			PBXFileElement fileReference = xcodeProject.getFileReferenceWithPath(frameworkPath);</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">			if (fileReference == null) {</span>
<span class="fc" id="L154">				fileReference = xcodeProject.getFileReferenceWithPath(&quot;\&quot;&quot; + frameworkPath + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">				if (fileReference == null) {</span>
<span class="fc" id="L156">					fileReference = xcodeProject.createFileReference(frameworkPath, &quot;SOURCE_ROOT&quot;);</span>
				}
			}
<span class="fc" id="L159">			fileReferences.add(fileReference.getReference());</span>
<span class="fc" id="L160">		}</span>
<span class="fc" id="L161">		return fileReferences;</span>
	}
	
	public void createGroup(List&lt;CommentedIdentifier&gt; identifiers) {
		//Add/Edit the Frameworks group
<span class="fc" id="L166">		String frameworkGroupIdentifier = null;</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">		for(PBXFileElement group : xcodeProject.getGroups()) {</span>
<span class="pc bpc" id="L168" title="1 of 6 branches missed.">			if (group.getName() != null &amp;&amp; (group.getName().equals(&quot;Frameworks&quot;) || group.getName().equals(&quot;\&quot;Frameworks\&quot;&quot;))) {</span>
<span class="fc" id="L169">				frameworkGroupIdentifier = group.getReference().getIdentifier();</span>
			}
<span class="fc" id="L171">		}</span>
		
<span class="fc bfc" id="L173" title="All 2 branches covered.">		if (frameworkGroupIdentifier != null) {</span>
<span class="fc" id="L174">			PBXFileElement frameworkGroup = xcodeProject.getGroupWithIdentifier(frameworkGroupIdentifier);</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">			for (CommentedIdentifier fileReference : identifiers) {</span>
<span class="fc" id="L176">				boolean found = false;</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">				for (CommentedIdentifier child : frameworkGroup.getChildren()) {</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">					if (child.getComment().equals(fileReference.getComment())) {</span>
<span class="fc" id="L179">						found = true;</span>
					}
<span class="fc" id="L181">				}</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">				if (!found) {</span>
<span class="nc" id="L183">					frameworkGroup.addChild(fileReference);</span>
				}
<span class="fc" id="L185">			}</span>
<span class="fc" id="L186">		} else {</span>
<span class="fc" id="L187">			String mainGroupIdentifier = xcodeProject.getProject().getMainGroup().getIdentifier();</span>
<span class="fc" id="L188">			xcodeProject.createGroup(&quot;Frameworks&quot;, identifiers, mainGroupIdentifier);</span>
		}
<span class="fc" id="L190">	}</span>
	
	public void linkLibraries(String targetIdentifier, List&lt;CommentedIdentifier&gt; identifiers) {
		//Get the configuration list identifier for the first target
<span class="fc" id="L194">		String existingFrameworksPhaseId = null;</span>
<span class="fc" id="L195">		PBXTarget nativeTarget = xcodeProject.getNativeTargetWithIdentifier(targetIdentifier);</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">		for(CommentedIdentifier buildPhaseIdentifier : nativeTarget.getBuildPhases()) {</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">			if (buildPhaseIdentifier.getComment().equals(&quot;Frameworks&quot;)) {</span>
<span class="fc" id="L198">				existingFrameworksPhaseId = buildPhaseIdentifier.getIdentifier();</span>
<span class="fc" id="L199">				break;</span>
			}
<span class="fc" id="L201">		}</span>
		//Add the framework build files to the frameworks build phase
<span class="fc" id="L203">		PBXBuildPhase frameworksBuildPhase = xcodeProject.getFrameworksBuildPhaseWithIdentifier(existingFrameworksPhaseId);</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">		if (frameworksBuildPhase.getReference().getIdentifier().equals(existingFrameworksPhaseId)) {</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">			for(CommentedIdentifier identifier : identifiers) {</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">				if (!frameworksBuildPhase.getFiles().contains(identifier)) {</span>
<span class="fc" id="L207">					frameworksBuildPhase.getFiles().add(identifier);</span>
				}
<span class="fc" id="L209">			}</span>
		}
<span class="fc" id="L211">	}</span>
	
	public void embedLibraries(PBXTarget target, List&lt;CommentedIdentifier&gt; identifiers) {
		//If the Embed Frameworks phase doesn't exist, create it
<span class="fc" id="L215">		boolean foundExistingPhase = false;</span>
<span class="fc" id="L216">		String copyFrameworksBuildPhaseIdentifier = null;</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">		for(CommentedIdentifier buildPhase : target.getBuildPhases()) {</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">			if (buildPhase.getComment().contains(&quot;Embed Frameworks&quot;)) {</span>
<span class="fc" id="L219">				copyFrameworksBuildPhaseIdentifier = buildPhase.getIdentifier();</span>
			}
<span class="fc" id="L221">		}</span>
<span class="fc bfc" id="L222" title="All 2 branches covered.">		for(PBXBuildPhase copyFilesBuildPhase : xcodeProject.getCopyFilesBuildPhases()) {</span>
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">			if (copyFilesBuildPhase.getReference().getIdentifier().equals(copyFrameworksBuildPhaseIdentifier)) {</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">				for(CommentedIdentifier identifier : identifiers) {</span>
<span class="fc" id="L225">					boolean foundFile = false;</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">					for (CommentedIdentifier fileIdentifier : copyFilesBuildPhase.getFiles()) {</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">						if (fileIdentifier.getComment().equals(identifier.getComment())) {</span>
<span class="fc" id="L228">							foundFile = true;</span>
						}
<span class="fc" id="L230">					}</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">					if (!foundFile) {</span>
<span class="nc" id="L232">						copyFilesBuildPhase.getFiles().add(identifier);</span>
					}
<span class="fc" id="L234">				}</span>
<span class="fc" id="L235">				foundExistingPhase = true;</span>
			}
<span class="fc" id="L237">		}</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">		if (!foundExistingPhase) {</span>
<span class="fc" id="L239">			PBXBuildPhase copyFrameworksBuildPhase = new PBXBuildPhase(&quot;PBXCopyFilesBuildPhase&quot;, &quot;\&quot;Embed Frameworks\&quot;&quot;, identifiers, &quot;\&quot;\&quot;&quot;, 10);</span>
<span class="fc" id="L240">			xcodeProject.addCopyFilesBuildPhase(target.getReference().getIdentifier(), copyFrameworksBuildPhase);</span>
		}
<span class="fc" id="L242">	}</span>
	
	public PBXTarget getNativeTarget(String targetName) {
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">		for (PBXTarget target : xcodeProject.getNativeTargets()) {</span>
<span class="pc bpc" id="L246" title="4 of 6 branches missed.">			if (target.getName() != null &amp;&amp; (target.getName().equals(targetName) || target.getName().equals(&quot;\&quot;&quot; + targetName + &quot;\&quot;&quot;))) {</span>
<span class="fc" id="L247">				return target;</span>
			}
<span class="nc" id="L249">		}</span>
<span class="nc" id="L250">		return null;</span>
	}
	
	public void writeProject() throws IOException {
<span class="nc" id="L254">		Files.write(Paths.get(pbxProjLocation), xcodeProject.toString().getBytes());</span>
<span class="nc" id="L255">	}</span>
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.0.201403182114</span></div></body></html>